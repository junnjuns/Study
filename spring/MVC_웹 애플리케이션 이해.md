스프링 MVC 1편 - 백엔드 웹 개발 핵심 기술

---

# 웹 서버

- 정적 리소스 제공 -> 정적이기에 HTML을 특정 사용자마다 다르게 보여줄 수 없다.
- 대표적으로 NGINX, APACHE 라는 웹 서버가 있다.

---

# 웹 애플리케이션 서버(WAS)

- 웹 서버 기능 포함한다.
- 프로그램 코드를 실행해서 애플리케이션 로직 수행 -> 특정 사용자마다 다르게 보여줄 수 있다.
    - 동적 HTML, HTTP API(JSON)
    - 서블릿, JSP, 스프링 MVC
- 대표적으로 Tomcat, Undertow 라는 WAS가 있다.

---

# 웹 시스템 구성
## WAS, DB로 구성

- WAS, DB만으로 시스템 구성이 가능하다.
- WAS는 정적 리소스, 애플리케이션 로직 모두 제공 가능하다.
- 단점
    - WAS가 너무 많은 역할을 담당하기 때문에 서버 과부하가 우려된다. 
    - 애플리케이션 로직(비싼 자원)이 정적 리소스(저렴한 자원) 때문에 수행이 어려울 수 있다.
    - WAS 장애시 오류화면조차도 노출이 불가능하다.


## WEB, WAS, DB로 구성

- 웹 서버를 앞에 두고 정적 리소스를 처리한다.
- 웹서버는 애플리케이션 로직같은 동적인 처리가 필요하면 WAS에 요청을 위임한다.
- 장점
    - WAS는 굉장히 중요한 애플리케이션 로직에 집중할 수 있다.
    - 시스템 리소스를 효율적으로 사용할 수 있다.
        -정적 리소스가 많이 사용되면 웹 서버 증설
        -애플리케이션 리소스가 많이 사용되면 WAS 증성
    - 정적 리소스만 제공하는 WEB은 잘 죽지 않는다.
    - WAS 서버는 장애가 자주 나타는데 WAS, DB 장애시 WEB 서버가 오류 화면을 제공할 수 있다.
    
---

# 서블릿

- 클라이언트에서 서버로 요청이 왔을 때 서블릿 코드에 있는 service가 실행된다.
- service가 호출되면서 HttpServletRequest, HttpServletResponse 2개의 파라미터를 받는다.
    : Http에 대한 요청정보를 편리하게 사용할 수 있다.
- 개발자는 request, response 객체를 편하게 사용하면 된다.
- 서블릿을 통해 개발자는 HTTP 스펙을 매우 편리하게 사용할 수 있다.

---

## HTTP 요청, 응답 흐름

- HTTP 요청시
    - WAS는 Request, Response 객체를 새로 만들어서 서블릿 객체 호출
    - 개발자는 Request 객체에서 HTTP 요청 정보를 편리하게 꺼내서 사용
    - 개발자는 Response 객체에 HTTP 응답 정보를 편리하게 입력
    - WAS는 Response 객체에 담겨있는 내용으로 HTTP 응답 정보를 생성

---

## 서블릿 컨테이너

- 서블릿을 지원하는 WAS를 서블릿 컨테이너라고 한다. ex) 톰캣
- 서블릿 객체를 생성, 초기화, 호출, 종료하는 생명주기 관리
- 서블릿 객체는 싱글톤으로 관리한다.
    - 싱글톤 : 객체를 딱 하나만 생성하고 그 객체를 공유해서 사용
    - 고객의 요청이 올 때 마다 계속 객체를 생성하는 것은 비효율적이다.
    - 최초 로딩 시점에 서블릿 객체를 미리 만들어두고 재활용한다.
    - 모든 고객 요청은 동일한 서블릿 객체 인스턴스에 접근한다.
    - **공유 변수, 멤버 변수 사용 시 주의**
    - 서블릿 컨테이너가 종료될 때 서블릿 객체도 함께 종료된다.
- WAS의 중요한 특징 : **동시 요청을 위한 멀티 쓰레드 처리 지원**
    -ex) 1000명, 10000명이 동시에 요청해도 서버가 요청을 잘 처리할 수 있다.

---

# 동시요청 - 멀티 쓰레드

- 쓰레드는 한번에 하나의 코드 라인만 수행한다. 그래서 **동시처리가 필요**하면 **쓰레드를 추가로 생성**해야한다.

---

## 요청 마다 쓰레드 생성

- 장점
    - 동시 요청을 처리할 수 있다.
    - 리소스(CPU, 메모리)가 허용될 때 까지 처리가능
    - 하나의 쓰레드가 지연 되어도 나머지 쓰레드는 정상 동작한다.

- 단점
    - 쓰레드 생성 비용은 매우 비싸다.
    - 고객의 요청이 올 때 마다 쓰레드를 생성하면 응답 속도가 늦어진다.
    - 쓰레드는 컨텍스트 스위칭 비용이 발생한다.
        -컨텍스트 스위칭 : 사용할 자원을 변경할 때 드는 비용
        -ex) A쓰레드에서 B쓰레드로 전환할 때 생기는 비용 
    - 쓰레드 생성에 제한이 없다. 
        -고객 요청이 너무 많이 오면 CPU, 메모리 임계점을 넘어서 서버가 죽을 수 있다.

---

## 쓰레드 풀

- 특징
    - 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다.
    - 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다.
            -ex) 톰캣은 최대 200개 기본 설정(변경 가능)
- 사용
    - 쓰레드가 필요하면 이미 생성되어 있는 쓰레드를 쓰레드 풀에서 꺼내서 사용한다.
    - 사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납한다.
    - 최대 쓰레드가 모두 사용중이어서 쓰레드 풀에 쓰레드가 없으면 기다리는 요청은 **거절**하거나 특정 숫자만큼 **대기**하도록 설정할 수 있다.
- 장점
    - 쓰레드가 미리 생성되어 있으므로 쓰레드를 생성하고 종료하는 비용(CPU)이 절약되고 응답 시간이 빠르다.
    - 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수있다.

### 실무 팁

- WAS의 주요 튜닝 포인트 : **최대 쓰레드 수(Max Thread)** 이다.
- Max Thread 수를 너무 낮게 설정하면?
    : 동시 요청이 많으면, 서버 리소스는 여유롭지만 클라이언트는 금방 응답이 지연된다.
- Max Thread 수를 너무 높게 설정하면?
    : 동시 요청이 많으면 CPU, 메모리 리소스 임계점 초과로 서버가 다운 될 가능성이 있다.
- 장애 발생시
    : 클라우드(고객 요청)면 일단 서버부터 늘리고 이후에 튜닝
    : 클라우드가 아니면 평상시에 튜닝
    
### 쓰레드 풀의 적정 숫자

- 애플리케이션 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 모두 다르다.
- 성능 테스트를 해야한다.
    -최대한 실제 서비스와 유사하게 환경을 만들고 성능 테스트를 시도한다.
    -툴: 아파치 ab, 제이미터, nGrinder 등


---

## WAS의 멀티 쓰레드 지원

**핵심**
- 멀티 쓰레드에 대한 부분은 WAS가 처리
- **개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 된다.**
- 개발자는 마치 싱**글 쓰레드 프로그래밍을 하듯이 편리하게 소스 코드를 개발한다.**
- 멀티 쓰레드 환경이므로 싱들톤 객체(서블릿, 스프링 빈)는 주의해서 사용한다.
    : 공유변수 주의해야 함

---

# 백엔드 개발자가 고민해야 해야하는 것

## 정적 리소스

- 고정된 HTML 파일, CSS, JS, 이미지, 영상 등을 제공
- 주로 웹 브라우저


## HTML 페이지

- 동적으로 필요한 HTML 파일을 생성해서 전달
- 웹 브라우저: HTML 해석


## HTTP API

- HTML이 아니라 데이터를 전달
- 주로 JSON 형식 사용
- 데이터만 주고 받는다. UI 화면이 필요하면 클라이언트가 별도로 처리

---

## SSR - 서버사이드 렌더링(학습 필수)

- HTML 최종 결과를 서버에서 만들어서 웹 브라우저에 전달
- 주로 정적인 화면에 사용
- 관련기술 : JSP, **타임리프** ->**백엔드 개발자**

---

## CSR - 클라이언트 사이드 렌더링

- HTML결과를 바로 받는 것이 아니라 **자바 스크립트**를 사용해 웹 브라우저에서 동적으로 생성해서 적용
- 웹 환경을 마치 앱 처럼 필요한 부분부분을 변경할 수 있음
- 관련기술 : React, Vue.js ->**웹 프론트엔드 개발자**

---

# 스프링 부트

 - 스프링을 편리하게 사용할 수 있게 해준다.
 - 스프링 부트는 서버를 내장하고 있다.
 - 과거에는 서버에 WAS를 직접 설치하고, 소스는 War 파일을 만들어서 설치한 WAS에 배포했다.
 - 스프링 부트는 빌드 결과(Jar)에 WAS 서버 포함 -> **빌드 배포 단순화**
 - 빌드할 때 빌드안에 서버를 넣으면 서버에 WAS를 설치 할 필요가 없다.


# 타임리프(Thymeleaf)

- 내추럴 템플릿 : HTML의 모양을 유지하면서 뷰 템플릿(HTML을 편리하게 생성하는 기능) 적용 가능 
- 스프링 MVC와 강력한 기능 통합


